<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>掲示板</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>掲示板</h1>
    <form id="postForm">
        <textarea id="postContent" placeholder="投稿内容を入力してください..." required></textarea>
        <button type="submit">投稿する</button>
    </form>
    <div id="postList">
        <!-- 投稿一覧をここに表示 -->
    </div>
    <button onclick="window.location.href='/home'">ホームに戻る</button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const postForm = document.getElementById("postForm");
        const postContent = document.getElementById("postContent");
        const postList = document.getElementById("postList");

        // 投稿一覧を取得して表示
        function loadPosts() {
            fetch("/api/posts")
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        postList.innerHTML = "";
                        data.posts.forEach((post) => {
                            addPostToList(post);
                        });
                    }
                });
        }

        // 投稿をリストに追加
        function addPostToList(post) {
            const postItem = document.createElement("div");
            postItem.className = "post";
            postItem.innerHTML = `
                <p><strong>${post.username}</strong> (${new Date(post.timestamp).toLocaleString()})</p>
                <p>${post.content}</p>
            `;
            postList.prepend(postItem); // 新しい投稿を先頭に追加
        }

        // 投稿フォームの送信
        postForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const content = postContent.value.trim();
            if (!content) return;

            fetch("/api/posts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        postContent.value = ""; // フォームをリセット
                    } else {
                        alert(data.message);
                    }
                });
        });

        // サーバーからの新しい投稿を受信
        socket.on("new_post", (post) => {
            addPostToList(post);
        });

        // 初期ロード
        loadPosts();
    </script>
</body>
</html>
